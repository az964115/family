<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#f0a500">
  <meta charset="UTF-8" />
  <title>🐷豬豬e網🐷</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      max-width: 900px;
      background-color: #fdf6e3;
      color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    h1,h2,h3,h4 { margin-top: 0; }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none;
      background-color: #f0a500; color: #fff;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s;
    }
    ul li button {
      background-color: #e74c3c;
      color: white;
      padding: 4px 8px;
      font-size: 14px;
      border-radius: 4px;
      margin-left: 10px;
    }
    ul li button:hover {
      background-color: #c0392b;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
      width: 100%; box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus { border-color: #f0a500; outline: none; }
    textarea { resize: vertical; }
    ul {
      padding-left: 15px; list-style: none; margin: 8px 0;
      max-height: 160px; overflow-y: auto;
      border-radius: 6px; box-shadow: inset 0 0 5px #ccc; background: #fff;
    }
    ul li {
      padding: 8px 12px; border-bottom: 1px solid #eee;
      cursor: pointer; transition: background-color 0.2s;
    }
    ul li:hover { background-color: #ffe8a3; }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    .header { text-align: center; margin-bottom: 20px; }
    .announcement {
      background-color: #fff8dc; border-left: 5px solid #f0a500;
      padding: 12px 15px; font-weight: bold; font-size: 1.1em;
      border-radius: 6px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .flex-grow { flex-grow: 1; min-width: 250px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    .small-note { font-size: 0.85em; color: #666; }
    .stat-box {
      background: #fff7cc; padding: 12px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa;
      font-weight: 600;
    }
    body.theme-day { background-color: #fdf6e3; color: #333; }
    body.theme-day .container { background: #fff3e0; color: #333; }
    body.theme-day .announcement { background-color: #fff8dc; border-left-color: #f0a500; color: #444; }
    body.theme-night { background-color: #121212; color: #eee; }
    body.theme-night .container { background: #1e1e1e; color: #eee; }
    body.theme-night .announcement { background-color: #2a2a2a; border-left-color: #ffa500; color: #eee; }
    body.theme-night button { background-color: #ffa500; color: #222; box-shadow: 0 3px 6px rgb(255 165 0 / 0.6); }
    body.theme-night input, body.theme-night select, body.theme-night textarea { background: #333; border-color: #555; color: #eee; }
    body.theme-night ul { background: #1a1a1a; box-shadow: inset 0 0 5px #ffa500aa; color: #eee; }
    body.theme-forest { background-color: #1e2f1e; color: #000; }
    body.theme-forest .container { background: #2e4d2e; color: #000; }
    body.theme-forest .announcement { background-color: #3a6e3a; border-left-color: #aed581; color: #dcedc8; }
    body.theme-forest button { background-color: #aed581; color: #2e4d2e; }
    body.theme-forest input, body.theme-forest select, body.theme-forest textarea { background: #486b48; border-color: #aed581; color: #e8f5e9; }
    #chart { max-width: 100%; height: 300px; margin-top: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgb(0 0 255 / 0.15); background-color: white; }
    .top-right { position: fixed; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 999; }
    .small-note { font-size: 0.85em; color: #777; }

  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="loginSection" class="container" style="max-width:400px; margin:auto;">
  <h2>👤 使用者登入</h2>
  <label>使用者名稱</label>
  <select id="loginUser">
    <option value="mom">媽媽</option>
    <option value="dad">爸爸</option>
    <option value="debby">妹妹</option>
    <option value="jason">Jason</option>
  </select>

  <label>密碼</label>
  <input type="password" id="loginPassword" placeholder="輸入密碼" />
  <button onclick="login()">登入</button>
</div>
<div id="mainContent" style="display:none;">
  <div class="top-right">
    <button onclick="setTheme('day')">🌞 白天</button>
    <button onclick="setTheme('night')">🌙 夜間</button>
    <button onclick="setTheme('forest')">🌿 森林</button>
    <button onclick="changePassword()">🔐 修改密碼</button>
    <button onclick="logout()">🚪 登出</button>
  </div>

  <div class="header">
    <h1>🐷 豬豬e網</h1>
    <div class="announcement">📢 記帳區上線啦！請媽媽和妹妹給我一百萬</div>
  </div>

  <div style="margin-bottom: 20px;">
    <section class="container">
      <h2>💬 家庭公告板</h2>
      <div id="boardMessages" style="background:#fff; padding:10px; border-radius:8px; max-height:200px; overflow-y:auto; box-shadow:inset 0 0 5px #ccc;"></div>
      <div style="margin-top:10px;">
        <textarea id="boardInput" placeholder="輸入留言..." rows="2"></textarea>
        <button onclick="postMessage()">發佈留言</button>
      </div>
    </section>

    <h3>🧩 新電影區 https://www.movieffm.net/home/</h3>
    <div style="overflow:hidden; border: 2px solid #f0a500; border-radius: 10px; height: 600px;">
      <iframe src="https://www.movieffm.net/home/"
        width="100%" height="600" style="transform:scale(1); transform-origin: 0 0; border:none;">
      </iframe>
    </div>

    <h3>🧩 免費貼圖區(更多)</h3>
    <div style="overflow:hidden; border: 2px solid #f0a500; border-radius: 10px; height: 600px;">
      <iframe src="https://lps-editor-3099.landpress.line.me/freesticker/?utm_source=OA&utm_medium=liverichmenu&utm_campaign=traffic_20250829_R1_0000_mass_sticker_C00_NA_non_liverichmenu"
        width="100%" height="600" style="transform:scale(1); transform-origin: 0 0; border:none;">
      </iframe>
    </div>

  <section class="container">
    <h2>📊 每日記帳</h2>

    <div class="flex-row">
      <div class="flex-grow">
        <label>選擇記帳人</label>
        <input type="text" id="roleSelect" readonly style="background:#eee; font-weight:bold;">
        <small class="small-note">目前登入的使用者</small>

        <small class="small-note">全家共用資料庫，角色只做分類用途。</small>
      </div>
      <div class="flex-grow">
        <label>選擇類別</label>
        <select id="categorySelect">
          <option value="食物">🍔 食物</option>
          <option value="交通">🚌 交通</option>
          <option value="娛樂">🎮 娛樂</option>
          <option value="其他">📝 其他</option>
        </select>
      </div>
    </div>
    <label>金額</label>
    <input type="number" id="amountInput" min="0" step="0.01" placeholder="輸入金額" />

    <label>描述</label>
    <textarea id="descriptionInput" rows="2" placeholder="輸入描述"></textarea>

    <button onclick="addRecord()">記錄支出</button>
    <hr>

    <hr>

    <h3>📜 最近記帳紀錄</h3>
    <ul id="recordList"><li>暫無記錄</li></ul>

    <hr>

    <h3>📈 支出統計</h3>
    <div id="statsBox" class="stat-box">
      <p>今日總支出：<span id="todayTotal">0</span> 元</p>
      <p>最近 7 天平均每日支出：<span id="avg7Days">0</span> 元</p>
      <p>最近 30 天平均每日支出：<span id="avg30Days">0</span> 元</p>
      <p>當月累計支出：<span id="monthTotal">0</span> 元</p>
      <p id="warningMsg" style="color:#c0392b; font-weight:bold;"></p>
    </div>
    <section class="container">
  <h2>💰 智慧理財顧問</h2>

  <div style="margin-bottom: 10px;">
    <label>月薪（元）</label>
    <input type="number" id="salaryInput" placeholder="例如 50000" />
    <button onclick="saveSalary()">💾 儲存月薪</button>
    <span id="salaryStatus" style="margin-left:8px;color:green;"></span>
  </div>

  <details style="margin-bottom: 15px;">
    <summary>⚙️ 自訂各類支出建議比例（%）</summary>
    <div style="margin-top: 8px;">
      <label>食物：</label><input type="number" id="limit_food" value="35" style="width:60px;">%
      <label style="margin-left:10px;">交通：</label><input type="number" id="limit_transport" value="15" style="width:60px;">%
      <label style="margin-left:10px;">娛樂：</label><input type="number" id="limit_entertainment" value="15" style="width:60px;">%
      <label style="margin-left:10px;">其他：</label><input type="number" id="limit_other" value="20" style="width:60px;">%
      <button onclick="saveLimits()" style="margin-left:10px;">💾 儲存</button>
    </div>
  </details>

  <button onclick="analyzeFinance()">📊 分析本月理財建議</button>
  <div id="financeAdvice" class="stat-box" style="margin-top:10px;">請輸入月薪並點擊分析</div>

  <canvas id="financeChart" style="margin-top:20px;max-width:400px;"></canvas>
</section>

    <h3>📊 各類別支出統計</h3>
    <label>開始日期</label>
    <input type="date" id="startDate" />

    <label>結束日期</label>
    <input type="date" id="endDate" />
    <button onclick="analyzeCategory()">查看統計</button>
    <div id="categoryResult" class="stat-box">點擊查看統計資料</div>
    <canvas id="categoryChart" style="margin-top: 15px;"></canvas>
  </section>

  <section class="container">
    <h2>📈 股票查詢</h2>
    <div class="flex-row">
      <div class="flex-grow"><input type="text" id="symbolInput" value="0050" placeholder="輸入股票代碼（如 2330）" /></div>
      <button onclick="loadStock()">查詢</button>
    </div>

    <div class="flex-row" style="margin-top:10px; gap:40px;">
      <div class="flex-grow">
        <h4>⭐ 自選股清單</h4>
        <p class="small-note" style="margin-top:-8px;">（顯示最新收盤價的漲跌變化，不是當前即時價）</p>
        <ul id="favoriteList"></ul>
        <div style="margin-top:10px;">
          <input type="text" id="newFavorite" placeholder="新增股票代碼" />
          <button onclick="addFavorite()">新增自選股</button>
        </div>
      </div>
      <div class="flex-grow" style="min-width:300px;">
        <h4>📊 股價走勢圖</h4>
        <p class="small-note" style="margin-top:-8px;">（請輸入代碼查詢，或點擊自選股項目）</p>
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>
  <section class="container">
      <h2>💼 我的投資組合</h2>
      <div class="flex-row">
        <div class="flex-grow">
          <label>股票代號</label>
          <input type="text" id="pfSymbol" placeholder="例如 2330" />
        </div>
        <div class="flex-grow">
          <label>持股數量</label>
          <input type="number" id="pfShares" placeholder="100" />
        </div>
        <div class="flex-grow">
          <label>成本價</label>
          <input type="number" id="pfCost" placeholder="560" />
        </div>
        <button onclick="addPortfolio()">新增</button>
      </div>

      <h3 style="margin-top:15px;">📋 我的持股列表</h3>
      <ul id="portfolioList"><li>暫無資料</li></ul>
    </section>

</div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let userRef = null; 
    let pfRef = null;

    function initForUser(user){
      userRef = db.ref(`users/${user}/records`);
      document.getElementById('roleSelect').value = user; 
      pfRef = db.ref(`users/${user}/portfolio`);
      loadRecentRecords();
      updateStats();
      loadPortfolio();
    }

    function deleteRecord(key) {
      if (!confirm("確定要刪除這筆紀錄嗎？")) return;

      userRef.child(key).remove(err => {
        if (err) {
          alert("刪除失敗！");
          console.error(err);
        } else {
          alert("已刪除紀錄！");
          loadRecentRecords(); 
          updateStats();   
        }
      });
    }
    const boardRef = db.ref("family/board");

    function loadBoard() {
      boardRef.limitToLast(10).on("value", snap => {
        const box = document.getElementById("boardMessages");
        const data = snap.val();
        const currentUser = localStorage.getItem("currentUser");
        box.innerHTML = "";
        if (!data) {
          box.innerHTML = "<p>目前沒有留言。</p>";
          return;
        }
        const entries = Object.entries(data)
          .map(([key, val]) => ({ key, ...val }))
          .sort((a,b)=>b.time-a.time);

        entries.forEach(m => {
          const t = new Date(m.time).toLocaleString('zh-TW');
          const div = document.createElement('div');
          div.style.borderBottom = "1px solid #eee";
          div.style.padding = "6px 0";
          div.innerHTML = `
            <b>${m.user}</b>：${m.msg}
            <span style="color:#777;font-size:0.85em;">(${t})</span>
            ${m.user === currentUser ? `<button style="margin-left:10px;font-size:12px;" onclick="deleteBoardMessage('${m.key}')">🗑️ 刪除</button>` : ""}
          `;
          box.appendChild(div);
        });
      });
    }
    function deleteBoardMessage(key) {
      if (!confirm("確定要刪除此留言？")) return;
      boardRef.child(key).remove()
        .then(()=>alert("留言已刪除"))
        .catch(e=>console.error(e));
    }
    function postMessage(){
      const msg = document.getElementById("boardInput").value.trim();
      if (!msg) return alert("請輸入內容");
      boardRef.push({
        user: localStorage.getItem("currentUser"),
        msg,
        time: Date.now()
      });
      document.getElementById("boardInput").value = "";
    }

    window.addEventListener("load", loadBoard);

    function loadPortfolio() {
      if (!pfRef) return;
      pfRef.on("value", async snap => {
        const data = snap.val() || {};
        const list = document.getElementById("portfolioList");
        list.innerHTML = "";

        for (const [code, info] of Object.entries(data)) {
          try {
            const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
            const stock = await res.json();
            let price = 0;
            if (stock.stat === "OK" && stock.data.length > 0) {
              const last = stock.data[stock.data.length - 1];
              price = parseFloat(last[6].replace(/,/g, ""));
            }
            const gain = ((price - info.cost) * info.shares).toFixed(2);
            const color = gain >= 0 ? "red" : "green"; 
            const li = document.createElement("li");
            li.innerHTML = `
              <b>${code}</b>｜${info.shares}股｜成本 ${info.cost}｜現價 ${price.toFixed(2)}｜
              <span style="color:${color}; font-weight:bold;">損益 ${gain}</span>
              <button onclick="removePortfolio('${code}')" style="margin-left:8px;">刪除</button>
            `;
            list.appendChild(li);
          } catch (e) {
            console.error(e);
          }
        }
        if (list.innerHTML === "") list.innerHTML = "<li>暫無資料</li>";
      });
    }

    function addPortfolio() {
      const code = pfSymbol.value.trim();
      const shares = parseFloat(pfShares.value);
      const cost = parseFloat(pfCost.value);
      if (!code || isNaN(shares) || isNaN(cost)) return alert("請輸入完整資料");
      pfRef.child(code).set({ shares, cost });
      pfSymbol.value = pfShares.value = pfCost.value = "";
    }

    function removePortfolio(code) {
      if (confirm("確定刪除這筆投資？")) pfRef.child(code).remove();
    }

    const USERS = {
  mom: "me",
  dad: "dt",
  debby: "dua",
  jason: "931"
};

    function logout() {
      localStorage.removeItem('currentUser');
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      recordList.innerHTML = '<li>暫無記錄</li>';
      todayTotalEl.textContent = '0';
      avg7Days.textContent = '0';
      avg30Days.textContent = '0';
      monthTotalEl.textContent = '0';
      warningMsg.textContent = '';
      alert('您已登出！');
    }
    async function changePassword() {
      const user = localStorage.getItem('currentUser');
      if (!user) return alert("請先登入");

      const oldPass = prompt("請輸入舊密碼：");
      if (!oldPass) return;

      const snap = await db.ref(`users/${user}/password`).get();
      const currentPass = snap.exists() ? snap.val() : USERS[user];

      if (oldPass !== currentPass) {
        alert("舊密碼錯誤！");
        return;
      }

      const newPass = prompt("請輸入新密碼（至少3個字）");
      if (!newPass || newPass.length < 3) {
        alert("新密碼無效！");
        return;
      }

      await db.ref(`users/${user}/password`).set(newPass);
      USERS[user] = newPass; 
      localStorage.setItem('lastChangedPass', newPass);

      alert("✅ 密碼修改成功，下次登入請使用新密碼！");
    }

    async function login(){
      const user = document.getElementById('loginUser').value;
      const pass = document.getElementById('loginPassword').value.trim();

      const ref = db.ref(`users/${user}/password`);
      const snap = await ref.get();
      let storedPass;

      if (snap.exists()) {
        storedPass = snap.val();
      } else {
        storedPass = USERS[user];
        await ref.set(storedPass);
      }
      if(pass === storedPass){
        localStorage.setItem('currentUser', user);
        alert(`歡迎回來，${user}!`);
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block'; 
        initForUser(user);
      } else {
        alert("密碼錯誤！");
        document.getElementById('loginPassword').value = "";
      }
    }
    function setTheme(mode){
      document.body.classList.remove('theme-day','theme-night','theme-forest');
      document.body.classList.add(`theme-${mode}`);
      localStorage.setItem('themeMode', mode);
    }
    setTheme(localStorage.getItem('themeMode') || 'day');

    const favRef = db.ref('favorites/stockList');

    function addRecord(){
      const role = roleSelect.value;
      const category = categorySelect.value;
      const amount = parseFloat(amountInput.value);
      const desc = descriptionInput.value.trim();
      if(isNaN(amount)||amount<=0){ alert('請輸入有效金額'); return; }
      const now = new Date();
      const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      const record={role,category,amount,description:desc,timestamp:now.getTime(),date:localDate};
      userRef.push(record,err=>{
        if(err){alert('儲存失敗');console.error(err);}
        else{alert('記帳成功');amountInput.value='';descriptionInput.value='';loadRecentRecords();updateStats();}
      });
    }

    function loadRecentRecords(){
      userRef.orderByChild('timestamp').limitToLast(20).once('value', snap => {
        const records = snap.val(), list = recordList;
        list.innerHTML = '';
        if (!records) {
          list.innerHTML = '<li>暫無記錄</li>';
          return;
        }
        Object.entries(records)
          .sort((a, b) => b[1].timestamp - a[1].timestamp)
          .forEach(([key, r]) => {
            const li = document.createElement('li');
            li.innerHTML = `
              <div style="display:flex; justify-content: space-between; align-items: center;">
                <span>${r.date} - ${r.role} - ${r.category} - ${r.amount} 元 - ${r.description}</span>
                <button onclick="deleteRecord('${key}')">🗑️ 刪除</button>
              </div>
            `;
            list.appendChild(li);
          });
      });
    }


    async function updateStats(){
      const snap=await userRef.once('value');
      const arr=Object.values(snap.val()||[]);
      if (arr.length === 0) return;
      
      const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);

      const now=Date.now(),day=86400000;
      const todayTotal=arr.filter(r=>r.date===today).reduce((s,r)=>s+r.amount,0);
      const arr7=arr.filter(r=>now-r.timestamp<7*day);
      const arr30 = arr.filter(r => now - r.timestamp < 30*day);
      
      const avg7 = +(arr7.reduce((s,r)=>s+r.amount,0)/7).toFixed(2);
      const avg30 = +(arr30.reduce((s,r)=>s+r.amount,0)/30).toFixed(2);
      const month=today.slice(0,7);
      const monthTotal=arr.filter(r=>r.date.startsWith(month)).reduce((s,r)=>s+r.amount,0);
      warningMsg.textContent=todayTotal>1000?"⚠️ 今日花太多啦！":"";
      todayTotalEl.textContent=todayTotal.toFixed(2);
      avg7Days.textContent = avg7.toFixed(2);
      avg30Days.textContent = avg30.toFixed(2);
      monthTotalEl.textContent = monthTotal.toFixed(2);
    }
    function analyzeCategory() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;

      if (!start || !end) {
        alert('請選擇完整的起訖日期');
        return;
      }
      if (start > end) {
        alert('起始日期不能晚於結束日期');
        return;
      }
      userRef.once('value').then(snap => {
      const records = Object.values(snap.val() || []);
        if (records.length === 0) {
        categoryResult.textContent = '暫無資料';
        return;
      }
      const filtered = records.filter(r => r.date >= start && r.date <= end);
      if (filtered.length === 0) {
        categoryResult.textContent = '此區間無資料';
        if (window.categoryChart) window.categoryChart.destroy();
        return;
      }
      const categoryMap = {};
      filtered.forEach(r => {
        categoryMap[r.category] = (categoryMap[r.category] || 0) + r.amount;
      });

      const categories = Object.keys(categoryMap);
      const values = categories.map(c => categoryMap[c]);

      categoryResult.innerHTML = categories.map(c =>
        `${c}: ${categoryMap[c].toFixed(2)} 元`
      ).join('<br>');

      if (window.categoryChart) window.categoryChart.destroy();
      const ctx = document.getElementById('categoryChart').getContext('2d');
      window.categoryChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: categories,
          datasets: [{
            label: '各類別支出總額',
            data: values,
            backgroundColor: ['#f39c12', '#3498db', '#2ecc71', '#9b59b6'],
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: getComputedStyle(document.body).color }
            },
            x: {
              ticks: { color: getComputedStyle(document.body).color }
            }
          },
          plugins: {
            legend: {
              labels: { color: getComputedStyle(document.body).color }
            }
          }
        }
      });
    });
  }
function saveSalary() {
  const salary = parseFloat(document.getElementById('salaryInput').value);
  if (isNaN(salary) || salary <= 0) {
    alert('請輸入有效的月薪金額');
    return;
  }
  const currentUser = localStorage.getItem('currentUser');
  localStorage.setItem(`${currentUser}_salary`, salary);
  document.getElementById('salaryStatus').textContent = `已儲存：${salary} 元`;
}

function saveLimits() {
  const limits = {
    food: parseFloat(document.getElementById('limit_food').value),
    transport: parseFloat(document.getElementById('limit_transport').value),
    entertainment: parseFloat(document.getElementById('limit_entertainment').value),
    other: parseFloat(document.getElementById('limit_other').value)
  };
  const currentUser = localStorage.getItem('currentUser');
  localStorage.setItem(`${currentUser}_limits`, JSON.stringify(limits));
  alert('已儲存自訂支出比例設定！');
}

let financeChart; 

function analyzeFinance() {
  const salary = parseFloat(document.getElementById('salaryInput').value);
  if (isNaN(salary) || salary <= 0) {
    alert('請輸入有效的月薪金額');
    return;
  }
  const currentUser = localStorage.getItem('currentUser'); 
  const limits = JSON.parse(localStorage.getItem(`${currentUser}_limits`) || '{}'); 
  const limitDefaults = { food: 35, transport: 15, entertainment: 15, other: 20 };
  const mergedLimits = { ...limitDefaults, ...limits };

  userRef.once('value').then(snap => {
    const records = Object.values(snap.val() || []);
    if (records.length === 0) {
      document.getElementById('financeAdvice').textContent = '暫無支出資料';
      return;
    }

    const now = new Date();
    const thisMonth = now.toISOString().slice(0, 7); 
    const monthRecords = records.filter(r => r.date.startsWith(thisMonth));

    if (monthRecords.length === 0) {
      document.getElementById('financeAdvice').textContent = `本月（${thisMonth}）尚無記帳資料`;
      return;
    }

    const total = monthRecords.reduce((sum, r) => sum + r.amount, 0);
    const categoryMap = {};
    monthRecords.forEach(r => {
      categoryMap[r.category] = (categoryMap[r.category] || 0) + r.amount;
    });

    let adviceText = `<p>📅 本月(${thisMonth})總支出：${total.toFixed(2)} 元（${(total/salary*100).toFixed(1)}% 月薪）</p><ul>`;
    for (const [cat, amt] of Object.entries(categoryMap)) {
      const pct = amt / salary * 100;
      let limit = mergedLimits.other;
      if (cat === '食物') limit = mergedLimits.food;
      else if (cat === '交通') limit = mergedLimits.transport;
      else if (cat === '娛樂') limit = mergedLimits.entertainment;

      let msg = "";
      if (pct > limit) msg = `⚠️ 超出建議 ${limit}% 上限，建議檢視支出。`;
      else if (pct > limit * 0.8) msg = `⚠️ 接近上限 (${limit}%)，請留意控制。`;
      else msg = `✅ 在合理範圍內。`;

      adviceText += `<li>${cat}：${amt.toFixed(2)} 元（${pct.toFixed(1)}%）→ ${msg}</li>`;
    }
    adviceText += "</ul>";

    if (total > salary * 0.9)
      adviceText += `<p style="color:red;font-weight:bold;">🚨 本月支出已達月薪 90%，請立即檢視開銷！</p>`;
    else if (total < salary * 0.6)
      adviceText += `<p style="color:green;">🌱 儲蓄比例超過 40%，持續保持！</p>`;

    document.getElementById('financeAdvice').innerHTML = adviceText;

    const ctx = document.getElementById('financeChart').getContext('2d');
    if (financeChart) financeChart.destroy();
    financeChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: Object.keys(categoryMap),
        datasets: [{
          data: Object.values(categoryMap),
          backgroundColor: ['#4CAF50', '#2196F3', '#FFC107', '#FF5722', '#9C27B0']
        }]
      },
      options: {
        plugins: {
          title: { display: true, text: `各類支出佔比（共 ${total.toFixed(0)} 元）` },
          legend: { position: 'bottom' }
        }
      }
    });
  });
}
    async function loadFavorites() {
  favRef.once('value', async snap => {
    const favs = snap.val() || {};
    const list = favoriteList;
    list.innerHTML = '';
    const codes = Object.keys(favs);
    if (codes.length === 0) {
      favRef.update({ '2330': true, '0050': true });
      return loadFavorites();
    }

    for (const code of codes) {
      try {
        const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${code}`);
        const data = await res.json();
        if (data.stat === "OK" && data.data.length > 1) {
          const last = parseFloat(data.data[data.data.length - 1][6].replace(/,/g, ""));
          const prev = parseFloat(data.data[data.data.length - 2][6].replace(/,/g, ""));
          const diff = (last - prev).toFixed(2);
          const color = diff >= 0 ? "red" : "green";
          const li = document.createElement('li');
          li.innerHTML = `${code} <span style="color:${color};">(${diff >= 0 ? '▲' : '▼'}${Math.abs(diff)})</span>`;
          li.addEventListener('click', () => { symbolInput.value = code; loadStock(); });
          list.appendChild(li);
        }
      } catch (e) {
        console.error(e);
      }
    }
  });
}
    function addFavorite(){
      const code=newFavorite.value.trim();
      if(!code.match(/^\d+$/)){alert('請輸入有效代碼');return;}
      favRef.update({[code]:true});newFavorite.value='';loadFavorites();
    }
    const chartCtx=document.getElementById('chart').getContext('2d');
    let stockChart=null;
    async function loadStock(){
      const symbol=symbolInput.value.trim();
      if(!symbol.match(/^\d+$/)){alert('請輸入有效代碼');return;}
      try{
        const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${symbol}`);
        const data = await res.json();
        console.log("TWSE 回傳：", data);
        
        if (data.stat !== "OK" || !data.data) {
          alert('查詢失敗（代碼錯誤或暫無資料）');
          return;
        }
        const labels = data.data.map(row => {
          const parts = row[0].split('/');
          const year = parseInt(parts[0]) + 1911; 
          return `${year}-${parts[1]}-${parts[2]}`;
        });
        const prices = data.data.map(row => parseFloat(row[6].replace(/,/g, '')));
        if (stockChart) stockChart.destroy();
        stockChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: `${symbol} 收盤價`,
              data: prices,
              borderColor: 'rgba(240,165,0,0.9)',
              backgroundColor: 'rgba(240,165,0,0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: getComputedStyle(document.body).color } }
            },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).color } },
              y: { ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert('股票查詢失敗（請檢查網路或 API 狀態）');
      }
    }
window.addEventListener('load', () => {
  const currentUser = localStorage.getItem('currentUser');

  if (currentUser) {
    userRef = db.ref(`users/${currentUser}/records`);
    pfRef = db.ref(`users/${currentUser}/portfolio`);
    document.getElementById('roleSelect').value = currentUser;
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block';
    loadRecentRecords();
    updateStats();
    loadPortfolio();
    loadFavorites();
  } else {
    document.getElementById('loginSection').style.display = 'block';
    document.getElementById('mainContent').style.display = 'none';
  }

  const today = new Date().toISOString().split('T')[0];
  document.getElementById('recordDate').value = today;

  if (currentUser) {
    const savedSalary = localStorage.getItem(`${currentUser}_salary`);
    if (savedSalary) {
      document.getElementById('salaryInput').value = savedSalary;
      document.getElementById('salaryStatus').textContent = `已載入上次設定：${savedSalary} 元`;
    }

    const limits = JSON.parse(localStorage.getItem(`${currentUser}_limits`) || '{}');
    for (const key of ['food', 'transport', 'entertainment', 'other']) {
      if (limits[key]) document.getElementById(`limit_${key}`).value = limits[key];
    }
  }

  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') document.body.classList.add('dark-theme');

  loadMessages();
  console.log("✅ 初始化完成");
});

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')
    .then(() => console.log("✅ Service Worker 註冊完成"))
    .catch(err => console.error("❌ SW 註冊失敗", err));
}

  </script>
</body>
</html>
