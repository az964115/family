<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ· è±¬è±¬å…§ç¶² å…¨æ–°ç‰ˆ</title>
  <style>
    /* Reset & åŸºæœ¬ */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      max-width: 900px;
      background-color: #fdf6e3;
      color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    h1,h2,h3,h4 {
      margin-top: 0;
    }
    button {
      cursor: pointer;
      padding: 8px 14px;
      font-size: 16px;
      border-radius: 5px;
      border: none;
      background-color: #f0a500;
      color: #fff;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #d88e00;
    }
    input, select, textarea {
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 5px;
      width: 100%;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #f0a500;
      outline: none;
    }
    textarea {
      resize: vertical;
    }
    ul {
      padding-left: 15px;
      list-style: none;
      margin: 8px 0;
      max-height: 160px;
      overflow-y: auto;
      border-radius: 6px;
      box-shadow: inset 0 0 5px #ccc;
      background: #fff;
    }
    ul li {
      padding: 8px 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    ul li:hover {
      background-color: #ffe8a3;
    }
    .container {
      background: #fff3e0;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 25px;
      box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .announcement {
      background-color: #fff8dc;
      border-left: 5px solid #f0a500;
      padding: 12px 15px;
      font-weight: bold;
      font-size: 1.1em;
      border-radius: 6px;
      box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    .flex-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .flex-grow {
      flex-grow: 1;
      min-width: 250px;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 6px;
    }
    .small-text {
      font-size: 0.85em;
      color: #666;
    }
    .stat-box {
      background: #fff7cc;
      padding: 12px;
      border-radius: 8px;
      margin-top: 10px;
      box-shadow: inset 0 0 6px #f0a500aa;
      font-weight: 600;
    }
    /* ä¸»é¡Œåˆ‡æ› */
    body.theme-day {
      background-color: #fdf6e3;
      color: #333;
    }
    body.theme-day .container {
      background: #fff3e0;
      color: #333;
    }
    body.theme-day .announcement {
      background-color: #fff8dc;
      border-left-color: #f0a500;
      color: #444;
    }
    body.theme-day button {
      background-color: #f0a500;
      color: #fff;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
    }
    body.theme-day button:hover {
      background-color: #d88e00;
    }

    body.theme-night {
      background-color: #121212;
      color: #eee;
    }
    body.theme-night .container {
      background: #222;
      color: #eee;
    }
    body.theme-night .announcement {
      background-color: #2a2a2a;
      border-left-color: #ffa500;
      color: #eee;
    }
    body.theme-night button {
      background-color: #ffa500;
      color: #222;
      box-shadow: 0 3px 6px rgb(255 165 0 / 0.6);
    }
    body.theme-night button:hover {
      background-color: #e69500;
    }
    body.theme-night input, body.theme-night select, body.theme-night textarea {
      background: #333;
      border-color: #555;
      color: #eee;
    }
    body.theme-night input:focus, body.theme-night select:focus, body.theme-night textarea:focus {
      border-color: #ffa500;
      outline: none;
    }
    body.theme-night ul {
      background: #1a1a1a;
      box-shadow: inset 0 0 5px #ffa500aa;
      color: #eee;
    }
    body.theme-night ul li {
      border-bottom: 1px solid #444;
      color: #eee;
    }
    body.theme-night ul li:hover {
      background-color: #4a2e00;
    }

    body.theme-forest {
      background-color: #1e2f1e;
      color: #e8f5e9;
    }
    body.theme-forest .container {
      background: #2e4d2e;
      color: #e8f5e9;
    }
    body.theme-forest .announcement {
      background-color: #3a6e3a;
      border-left-color: #aed581;
      color: #dcedc8;
    }
    body.theme-forest button {
      background-color: #aed581;
      color: #2e4d2e;
      box-shadow: 0 3px 6px rgb(174 213 129 / 0.6);
    }
    body.theme-forest button:hover {
      background-color: #9ccc65;
    }
    body.theme-forest input, body.theme-forest select, body.theme-forest textarea {
      background: #486b48;
      border-color: #aed581;
      color: #e8f5e9;
    }
    body.theme-forest input:focus, body.theme-forest select:focus, body.theme-forest textarea:focus {
      border-color: #dcedc8;
      outline: none;
    }
    body.theme-forest ul {
      background: #3a6e3a;
      box-shadow: inset 0 0 5px #aed581cc;
      color: #dcedc8;
    }
    body.theme-forest ul li {
      border-bottom: 1px solid #598559;
      color: #dcedc8;
    }
    body.theme-forest ul li:hover {
      background-color: #6fa46f;
    }

    /* å…¶ä»– */
    #chart {
      max-width: 100%;
      height: 300px;
      margin-top: 15px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgb(0 0 255 / 0.15);
      background-color: white;
    }
    .top-right {
      position: fixed;
      top: 15px;
      right: 15px;
      display: flex;
      gap: 8px;
      z-index: 999;
    }
    .top-right button {
      padding: 6px 12px;
      font-size: 14px;
      background-color: #f0a500;
      border-radius: 20px;
      box-shadow: 0 2px 5px rgb(0 0 0 / 0.15);
    }
    .top-right button:hover {
      background-color: #d88e00;
    }
    .small-note {
      font-size: 0.85em;
      color: #777;
    }
  </style>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

</head>
<body>

  <div class="top-right" aria-label="ä¸»é¡Œåˆ‡æ›">
    <button onclick="setTheme('day')" aria-label="ç™½å¤©æ¨¡å¼">ğŸŒ ç™½å¤©</button>
    <button onclick="setTheme('night')" aria-label="å¤œé–“æ¨¡å¼">ğŸŒ™ å¤œé–“</button>
    <button onclick="setTheme('forest')" aria-label="æ£®æ—ç¶ æ¨¡å¼">ğŸŒ¿ æ£®æ—</button>
  </div>

  <div class="header">
    <h1>ğŸ· è±¬è±¬å…§ç¶² å…¨æ–°ç‰ˆ</h1>
    <div class="announcement">ğŸ“¢ è¨˜å¸³å€ä¸Šé™å•¦ï¼</div>
  </div>

  <!-- è¨˜å¸³å€å¡Š -->
  <section class="container" aria-label="æ¯æ—¥è¨˜å¸³">
    <h2>ğŸ“Š æ¯æ—¥è¨˜å¸³</h2>

    <div class="flex-row">
      <div class="flex-grow">
        <label for="roleSelect"><strong>é¸æ“‡è¨˜å¸³äºº</strong></label>
        <select id="roleSelect" aria-describedby="roleSelectHelp">
          <option value="mom">åª½åª½</option>
          <option value="dad">çˆ¸çˆ¸</option>
          <option value="sister">å¦¹å¦¹</option>
        </select>
        <small id="roleSelectHelp" class="small-note">å…¨å®¶å…±ç”¨è³‡æ–™åº«ï¼Œè§’è‰²åªåšåˆ†é¡ç”¨é€”ã€‚</small>
      </div>

      <div class="flex-grow">
        <label for="categorySelect"><strong>é¸æ“‡é¡åˆ¥</strong></label>
        <select id="categorySelect">
          <option value="é£Ÿç‰©">ğŸ” é£Ÿç‰©</option>
          <option value="äº¤é€š">ğŸšŒ äº¤é€š</option>
          <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
          <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="amountInput"><strong>é‡‘é¡</strong></label>
      <input type="number" id="amountInput" min="0" step="0.01" placeholder="è¼¸å…¥é‡‘é¡ (ä¾‹å¦‚ 100)" />
    </div>
    <div class="field">
      <label for="descriptionInput"><strong>æè¿°</strong></label>
      <textarea id="descriptionInput" rows="2" placeholder="è¼¸å…¥æè¿° (ä¾‹å¦‚ï¼šåˆé¤ã€è²·é£²æ–™)"></textarea>
    </div>
    <button onclick="addRecord()">è¨˜éŒ„æ”¯å‡º</button>

    <hr />

    <h3>ğŸ“… è‡ªè¨‚æœŸé–“æŸ¥è©¢</h3>
    <div class="flex-row">
      <div class="flex-grow">
        <label for="startDate"><strong>é–‹å§‹æ—¥æœŸ</strong></label>
        <input type="date" id="startDate" />
      </div>
      <div class="flex-grow">
        <label for="endDate"><strong>çµæŸæ—¥æœŸ</strong></label>
        <input type="date" id="endDate" />
      </div>
    </div>
    <button onclick="queryPeriodExpenses()">æŸ¥è©¢æœŸé–“æ”¯å‡º</button>
    <div id="periodResult" class="stat-box" aria-live="polite" style="margin-top:10px;">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</div>

    <hr />

    <h3>ğŸ“œ æœ€è¿‘è¨˜å¸³ç´€éŒ„</h3>
    <ul id="recordList" aria-live="polite">
      <li>æš«ç„¡è¨˜éŒ„</li>
    </ul>

    <hr />

    <h3>ğŸ“ˆ æ”¯å‡ºçµ±è¨ˆ</h3>
    <div id="statsBox" class="stat-box" aria-live="polite">
      <p>ä»Šæ—¥ç¸½æ”¯å‡ºï¼š<span id="todayTotal">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 7 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg7Days">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 30 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg30Days">0</span> å…ƒ</p>
      <p>ç•¶æœˆç´¯è¨ˆæ”¯å‡ºï¼š<span id="monthTotal">0</span> å…ƒ</p>
      <p id="warningMsg" style="color:#c0392b; font-weight:bold;"></p>
      <p>é æ¸¬ä¸‹é€±æ”¯å‡ºï¼šç´„ <span id="forecastWeek">0</span> å…ƒ</p>
    </div>

    <hr />

    <h3>ğŸ’¡ ä»Šæ—¥ç†è²¡å°èª</h3>
    <div id="dailyTip" class="announcement" aria-live="polite">
      è¼‰å…¥ä¸­...
    </div>
  </section>

  <!-- è‚¡ç¥¨æŸ¥è©¢å€ -->
  <section class="container" aria-label="è‚¡ç¥¨æŸ¥è©¢">
    <h2>ğŸ“ˆ è‚¡ç¥¨æŸ¥è©¢</h2>

    <div class="flex-row">
      <div class="flex-grow">
        <input type="text" id="symbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰" aria-label="è‚¡ç¥¨ä»£ç¢¼" />
      </div>
      <button onclick="loadStock()">æŸ¥è©¢</button>
    </div>

    <div class="flex-row" style="margin-top:10px; gap: 40px;">
      <div class="flex-grow">
        <h4>â­ è‡ªé¸è‚¡æ¸…å–®</h4>
        <ul id="favoriteList" aria-live="polite">
          <!-- ç”± JS å‹•æ…‹ç”¢ç”Ÿ -->
        </ul>
        <div style="margin-top:10px;">
          <input type="text" id="newFavorite" placeholder="æ–°å¢è‚¡ç¥¨ä»£ç¢¼" aria-label="æ–°å¢è‚¡ç¥¨ä»£ç¢¼" />
          <button onclick="addFavorite()">æ–°å¢è‡ªé¸è‚¡</button>
        </div>
      </div>
      <div class="flex-grow" style="min-width:300px;">
        <h4>ğŸ“Š è‚¡åƒ¹èµ°å‹¢åœ–</h4>
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>

  <script>
    // Firebase åˆå§‹åŒ–
    const firebaseConfig = {
      apiKey: "ä½ çš„APIKEY",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.firebaseio.com",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abcdef123456"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // é è¨­ä¸»é¡Œ
    function setTheme(mode) {
      document.body.classList.remove('theme-day', 'theme-night', 'theme-forest');
      if(mode === 'day') document.body.classList.add('theme-day');
      else if(mode === 'night') document.body.classList.add('theme-night');
      else if(mode === 'forest') document.body.classList.add('theme-forest');
      localStorage.setItem('themeMode', mode);
    }
    // è¼‰å…¥ä¸»é¡Œ
    const savedTheme = localStorage.getItem('themeMode') || 'day';
    setTheme(savedTheme);

    // è¨˜å¸³è³‡æ–™è®€å–/å¯«å…¥
    const recordsRef = db.ref('records');

    // è‡ªé¸è‚¡æ¸…å–®ï¼ˆå…¨å®¶å…±ç”¨ï¼‰
    const favRef = db.ref('favorites/stockList');

    // è®€å–è‡ªé¸è‚¡æ¸…å–®ä¸¦æ›´æ–°UI
    function loadFavorites() {
      favRef.once('value', snapshot => {
        const favs = snapshot.val() || {};
        const listEl = document.getElementById('favoriteList');
        listEl.innerHTML = '';
        const codes = Object.keys(favs);
        if(codes.length === 0){
          // é è¨­å…©éš»
          favRef.update({'2330':true, '0050':true});
          return loadFavorites();
        }
        codes.forEach(code => {
          const li = document.createElement('li');
          li.textContent = code;
          li.tabIndex = 0;
          li.title = `é»æ“ŠæŸ¥è©¢è‚¡ç¥¨ ${code}`;
          li.addEventListener('click', () => {
            document.getElementById('symbolInput').value = code;
            loadStock();
          });
          listEl.appendChild(li);
        });
      });
    }

    function addFavorite() {
      const input = document.getElementById('newFavorite');
      let code = input.value.trim().toUpperCase();
      if(!code.match(/^\d+$/)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼(ç´”æ•¸å­—)');
        return;
      }
      favRef.update({[code]: true});
      input.value = '';
      loadFavorites();
    }

    loadFavorites();

    // æ–°å¢è¨˜å¸³ç´€éŒ„
    function addRecord() {
      const role = document.getElementById('roleSelect').value;
      const category = document.getElementById('categorySelect').value;
      const amount = parseFloat(document.getElementById('amountInput').value);
      const desc = document.getElementById('descriptionInput').value.trim();
      if(isNaN(amount) || amount <= 0){
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡‘é¡');
        return;
      }
      const now = new Date();
      const record = {
        role,
        category,
        amount,
        description: desc,
        timestamp: now.getTime(),
        date: now.toISOString().slice(0,10)
      };
      // å­˜åˆ° Firebase
      recordsRef.push(record, error => {
        if(error) alert('å„²å­˜å¤±æ•—');
        else {
          alert('è¨˜å¸³æˆåŠŸï¼');
          document.getElementById('amountInput').value = '';
          document.getElementById('descriptionInput').value = '';
          loadRecentRecords();
          updateStats();
        }
      });
    }

    // é¡¯ç¤ºæœ€è¿‘è¨˜å¸³ç´€éŒ„
    function loadRecentRecords() {
      recordsRef.orderByChild('timestamp').limitToLast(20).once('value', snapshot => {
        const records = snapshot.val();
        const listEl = document.getElementById('recordList');
        listEl.innerHTML = '';
        if(!records) {
          listEl.innerHTML = '<li>æš«ç„¡è¨˜éŒ„</li>';
          return;
        }
        // è½‰æˆé™£åˆ—ä¸”ç”±æ–°åˆ°èˆŠ
        const arr = Object.values(records).sort((a,b)=>b.timestamp - a.timestamp);
        arr.forEach(rec => {
          const li = document.createElement('li');
          li.textContent = `${rec.date} - ${rec.role} - ${rec.category} - ${rec.amount} å…ƒ - ${rec.description}`;
          listEl.appendChild(li);
        });
      });
    }

    // æ”¯å‡ºçµ±è¨ˆè¨ˆç®—
    async function updateStats() {
      const snapshot = await recordsRef.once('value');
      const records = snapshot.val();
      if(!records){
        updateStatsUI([]);
        return;
      }
      const arr = Object.values(records);
      updateStatsUI(arr);
    }

    // è¨ˆç®—ä¸¦æ›´æ–°çµ±è¨ˆæ•¸æ“š UI
    function updateStatsUI(records) {
      const today = new Date().toISOString().slice(0,10);
      const todayRecords = records.filter(r => r.date === today);
      const todayTotal = todayRecords.reduce((sum, r)=> sum + r.amount, 0);

      // è¿‘7å¤©ã€30å¤©
      const nowTime = Date.now();
      const dayMS = 24*60*60*1000;
      const arr7days = records.filter(r => nowTime - r.timestamp < 7*dayMS);
      const arr30days = records.filter(r => nowTime - r.timestamp < 30*dayMS);

      const sum7 = arr7days.reduce((s,r)=> s+r.amount,0);
      const sum30 = arr30days.reduce((s,r)=> s+r.amount,0);
      const avg7 = (sum7 / 7).toFixed(2);
      const avg30 = (sum30 / 30).toFixed(2);

      // ç•¶æœˆç´¯è¨ˆ
      const yearMonth = today.slice(0,7);
      const monthRecords = records.filter(r => r.date.startsWith(yearMonth));
      const monthTotal = monthRecords.reduce((s,r)=> s+r.amount,0);

      // è­¦å‘Šè¨Šæ¯
      const warningMsgEl = document.getElementById('warningMsg');
      if(todayTotal > avg7 * 2){
        warningMsgEl.textContent = "âš ï¸ ä»Šæ—¥èŠ±å¤ªå¤šå•¦ï¼";
      } else {
        warningMsgEl.textContent = "";
      }

      // é æ¸¬ä¸‹é€±æ”¯å‡º (7æ—¥å‡*7)
      const forecastWeek = (avg7 * 7).toFixed(2);

      document.getElementById('todayTotal').textContent = todayTotal.toFixed(2);
      document.getElementById('avg7Days').textContent = avg7;
      document.getElementById('avg30Days').textContent = avg30;
      document.getElementById('monthTotal').textContent = monthTotal.toFixed(2);
      document.getElementById('forecastWeek').textContent = forecastWeek;
    }

    // æœŸé–“æŸ¥è©¢ç¸½æ”¯å‡º
    async function queryPeriodExpenses() {
      const start = document.getElementById('startDate').value;
      const end = document.getElementById('endDate').value;
      if(!start || !end){
        alert('è«‹è¼¸å…¥å®Œæ•´çš„é–‹å§‹åŠçµæŸæ—¥æœŸ');
        return;
      }
      if(start > end){
        alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');
        return;
      }
      const snapshot = await recordsRef.once('value');
      const records = snapshot.val();
      if(!records){
        document.getElementById('periodResult').textContent = "ç„¡æ”¯å‡ºç´€éŒ„";
        return;
      }
      const arr = Object.values(records);
      const filtered = arr.filter(r => r.date >= start && r.date <= end);
      const total = filtered.reduce((sum, r) => sum + r.amount, 0);
      document.getElementById('periodResult').textContent = `æœŸé–“å…§ç¸½æ”¯å‡ºï¼š${total.toFixed(2)} å…ƒ (${start} ~ ${end})`;
    }

    // æ¯æ—¥ç†è²¡å°èªï¼Œæ¯æ—¥æ ¹æ“šæ—¥æœŸè®Šæ›
    const dailyTips = [
      "ä»Šæ—¥èŠ±è²»è¦é©åº¦ï¼Œç†è²¡å¾å°äº‹åšèµ·ã€‚",
      "è¨˜å¸³å¹«åŠ©ä½ æŒæ¡æ¶ˆè²»ç‹€æ³ã€‚",
      "æŠ•è³‡å‰å…ˆåšå¥½é¢¨éšªè©•ä¼°ã€‚",
      "å®šæœŸæª¢è¦–è‡ªå·±çš„æ”¯å‡ºè¨ˆåŠƒã€‚",
      "æŠŠæ¡è¤‡åˆ©ï¼Œæ™‚é–“æ˜¯æœ€å¥½çš„æœ‹å‹ã€‚",
      "è¨˜å¾—å¤šå­˜ä¸€é»ï¼Œå‚™ç”¨é‡‘å¾ˆé‡è¦ã€‚",
      "è¨­ç«‹ç›®æ¨™ï¼Œè®“ç†è²¡æ›´æœ‰æ–¹å‘ã€‚",
      "é¿å…è¡å‹•æ¶ˆè²»ï¼Œç†æ™ºè³¼ç‰©ã€‚",
      "å¤šå­¸ç¿’ç†è²¡çŸ¥è­˜ï¼Œè²¡å¯Œå¢å€¼ã€‚",
      "ä¿æŒæ”¶æ”¯å¹³è¡¡ï¼Œç”Ÿæ´»ç„¡å£“åŠ›ã€‚"
    ];
    function updateDailyTip(){
      const dayIndex = new Date().getDate() % dailyTips.length;
      document.getElementById('dailyTip').textContent = dailyTips[dayIndex];
    }

    updateDailyTip();

    // è‚¡ç¥¨æŸ¥è©¢èˆ‡åœ–è¡¨
    const chartCtx = document.getElementById('chart').getContext('2d');
    let stockChart = null;

    async function loadStock(){
      const symbol = document.getElementById('symbolInput').value.trim();
      if(!symbol.match(/^\d+$/)) {
        alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„è‚¡ç¥¨ä»£ç¢¼ï¼ˆç´”æ•¸å­—ï¼‰');
        return;
      }
      // ä½¿ç”¨å°ç£è­‰äº¤æ‰€ API æˆ–å…¶ä»–å…è²»APIï¼Œé€™è£¡ä»¥ Finnhub æ›¿ä»£ç¤ºç¯„ï¼ˆéœ€ç”³è«‹API KEYï¼Œè«‹è‡ªè¡Œæ›¿æ›ï¼‰
      const token = "ä½ çš„_finnhub_API_KEY";
      try {
        // å–å¾—è¿‘30æ—¥æ”¶ç›¤åƒ¹
        const now = Math.floor(Date.now()/1000);
        const from = now - 86400*30;
        const res = await fetch(`https://finnhub.io/api/v1/stock/candle?symbol=TWS:${symbol}&resolution=D&from=${from}&to=${now}&token=${token}`);
        const data = await res.json();
        if(data.s !== "ok"){
          alert('ç„¡æ³•å–å¾—è‚¡ç¥¨è³‡æ–™');
          return;
        }
        const labels = data.t.map(ts => new Date(ts*1000).toISOString().slice(5,10));
        const prices = data.c;

        if(stockChart) stockChart.destroy();

        stockChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: `${symbol} æ”¶ç›¤åƒ¹`,
              data: prices,
              borderColor: 'rgba(240,165,0,0.9)',
              backgroundColor: 'rgba(240,165,0,0.2)',
              fill: true,
              tension: 0.3,
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: {
                labels: { color: getComputedStyle(document.body).color }
              }
            },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).color } },
              y: { ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      } catch(e) {
        alert('è‚¡ç¥¨è³‡æ–™è¼‰å…¥éŒ¯èª¤');
        console.error(e);
      }
    }

    // åˆå§‹è¼‰å…¥æœ€è¿‘è¨˜å¸³èˆ‡çµ±è¨ˆ
    loadRecentRecords();
    updateStats();

    // ä¸»å‹•æ›´æ–°æ¯æ—¥ç†è²¡å°èª
    setInterval(updateDailyTip, 1000*60*60); // æ¯å°æ™‚æ›´æ–°ï¼ˆä¸»è¦ç‚ºæ—¥åˆ‡æ›æ™‚æ›´æ–°ï¼‰

  </script>
</body>
</html>
