<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ·è±¬è±¬eç¶²ğŸ·</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 20px;
      max-width: 900px;
      background-color: #fdf6e3;
      color: #333;
      transition: background-color 0.4s, color 0.4s;
    }
    h1,h2,h3,h4 { margin-top: 0; }
    button {
      cursor: pointer; padding: 8px 14px; font-size: 16px;
      border-radius: 5px; border: none;
      background-color: #f0a500; color: #fff;
      box-shadow: 0 3px 6px rgb(0 0 0 / 0.15);
      transition: background-color 0.3s;
    }
    button:hover { background-color: #d88e00; }
    input, select, textarea {
      padding: 8px; font-size: 16px;
      border: 1px solid #ccc; border-radius: 5px;
      width: 100%; box-sizing: border-box;
      transition: border-color 0.3s;
    }
    input:focus, select:focus, textarea:focus { border-color: #f0a500; outline: none; }
    textarea { resize: vertical; }
    ul {
      padding-left: 15px; list-style: none; margin: 8px 0;
      max-height: 160px; overflow-y: auto;
      border-radius: 6px; box-shadow: inset 0 0 5px #ccc; background: #fff;
    }
    ul li {
      padding: 8px 12px; border-bottom: 1px solid #eee;
      cursor: pointer; transition: background-color 0.2s;
    }
    ul li:hover { background-color: #ffe8a3; }
    .container {
      background: #fff3e0; border-radius: 10px; padding: 20px;
      margin-bottom: 25px; box-shadow: 0 4px 8px rgb(0 0 0 / 0.1);
    }
    .header { text-align: center; margin-bottom: 20px; }
    .announcement {
      background-color: #fff8dc; border-left: 5px solid #f0a500;
      padding: 12px 15px; font-weight: bold; font-size: 1.1em;
      border-radius: 6px; box-shadow: 0 2px 6px rgb(0 0 0 / 0.1);
    }
    .flex-row { display: flex; gap: 20px; flex-wrap: wrap; }
    .flex-grow { flex-grow: 1; min-width: 250px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    .small-note { font-size: 0.85em; color: #666; }
    .stat-box {
      background: #fff7cc; padding: 12px; border-radius: 8px;
      margin-top: 10px; box-shadow: inset 0 0 6px #f0a500aa;
      font-weight: 600;
    }
    /* ä¸»é¡Œåˆ‡æ› */
    body.theme-day { background-color: #fdf6e3; color: #333; }
    body.theme-day .container { background: #fff3e0; color: #333; }
    body.theme-day .announcement { background-color: #fff8dc; border-left-color: #f0a500; color: #444; }
    body.theme-night { background-color: #121212; color: #000; }
    body.theme-night .container { background: #000; color: #000; }
    body.theme-night .announcement { background-color: #2a2a2a; border-left-color: #ffa500; color: #eee; }
    body.theme-night button { background-color: #ffa500; color: #222; box-shadow: 0 3px 6px rgb(255 165 0 / 0.6); }
    body.theme-night input, body.theme-night select, body.theme-night textarea { background: #333; border-color: #555; color: #eee; }
    body.theme-night ul { background: #1a1a1a; box-shadow: inset 0 0 5px #ffa500aa; color: #eee; }
    body.theme-forest { background-color: #1e2f1e; color: #000; }
    body.theme-forest .container { background: #2e4d2e; color: #000; }
    body.theme-forest .announcement { background-color: #3a6e3a; border-left-color: #aed581; color: #dcedc8; }
    body.theme-forest button { background-color: #aed581; color: #2e4d2e; }
    body.theme-forest input, body.theme-forest select, body.theme-forest textarea { background: #486b48; border-color: #aed581; color: #e8f5e9; }
    #chart { max-width: 100%; height: 300px; margin-top: 15px; border-radius: 10px; box-shadow: 0 4px 8px rgb(0 0 255 / 0.15); background-color: white; }
    .top-right { position: fixed; top: 15px; right: 15px; display: flex; gap: 8px; z-index: 999; }
    .small-note { font-size: 0.85em; color: #777; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
  <div id="loginSection" class="container" style="max-width:400px; margin:auto;">
  <h2>ğŸ‘¤ ä½¿ç”¨è€…ç™»å…¥</h2>
  <label>ä½¿ç”¨è€…åç¨±</label>
  <select id="loginUser">
    <option value="mom">åª½åª½</option>
    <option value="dad">çˆ¸çˆ¸</option>
    <option value="debby">å¦¹å¦¹</option>
    <option value="xiaoguai">å°ä¹–</option>
  </select>

  <label>å¯†ç¢¼</label>
  <input type="password" id="loginPassword" placeholder="è¼¸å…¥å¯†ç¢¼" />
  <button onclick="login()">ç™»å…¥</button>
</div>
<div id="mainContent" style="display:none;">
  <div class="top-right">
    <button onclick="setTheme('day')">ğŸŒ ç™½å¤©</button>
    <button onclick="setTheme('night')">ğŸŒ™ å¤œé–“</button>
    <button onclick="setTheme('forest')">ğŸŒ¿ æ£®æ—</button>
    <button onclick="logout()">ğŸšª ç™»å‡º</button>
  </div>

  <div class="header">
    <h1>ğŸ· è±¬è±¬eç¶² å°ä¹–&å°æ—è¯æ‰‹è£½ä½œ</h1>
    <div class="announcement">ğŸ“¢ è¨˜å¸³å€ä¸Šç·šå•¦ï¼è«‹åª½åª½å’Œå¦¹å¦¹çµ¦æˆ‘ä¸€ç™¾è¬</div>
  </div>

  <div style="margin-bottom: 20px;">
    <h3>ğŸ§© å°ç¶²é å€</h3>
    <iframe src="https://ani.gamer.com.tw/" width="100%" height="300" style="border: 2px solid #f0a500; border-radius: 10px;"></iframe>
  </div>
  <section class="container">
    <h2>ğŸ“Š æ¯æ—¥è¨˜å¸³</h2>

    <div class="flex-row">
      <div class="flex-grow">
        <label>é¸æ“‡è¨˜å¸³äºº</label>
        <input type="text" id="roleSelect" readonly style="background:#eee; font-weight:bold;">
        <small class="small-note">ç›®å‰ç™»å…¥çš„ä½¿ç”¨è€…</small>

        <small class="small-note">å…¨å®¶å…±ç”¨è³‡æ–™åº«ï¼Œè§’è‰²åªåšåˆ†é¡ç”¨é€”ã€‚</small>
      </div>
      <div class="flex-grow">
        <label>é¸æ“‡é¡åˆ¥</label>
        <select id="categorySelect">
          <option value="é£Ÿç‰©">ğŸ” é£Ÿç‰©</option>
          <option value="äº¤é€š">ğŸšŒ äº¤é€š</option>
          <option value="å¨›æ¨‚">ğŸ® å¨›æ¨‚</option>
          <option value="å…¶ä»–">ğŸ“ å…¶ä»–</option>
        </select>
      </div>
    </div>

    <label>é‡‘é¡</label>
    <input type="number" id="amountInput" min="0" step="0.01" placeholder="è¼¸å…¥é‡‘é¡" />

    <label>æè¿°</label>
    <textarea id="descriptionInput" rows="2" placeholder="è¼¸å…¥æè¿°"></textarea>

    <button onclick="addRecord()">è¨˜éŒ„æ”¯å‡º</button>
    <hr>

    <h3>ğŸ“… è‡ªè¨‚æœŸé–“æŸ¥è©¢</h3>
    <div class="flex-row">
      <div class="flex-grow"><input type="date" id="startDate" /></div>
      <div class="flex-grow">~~</div> 
      <div class="flex-grow"><input type="date" id="endDate" /></div>
    </div>
    <button onclick="queryPeriodExpenses()">æŸ¥è©¢æœŸé–“æ”¯å‡º</button>
    <div id="periodResult" class="stat-box">è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢</div>

    <hr>

    <h3>ğŸ“œ æœ€è¿‘è¨˜å¸³ç´€éŒ„</h3>
    <ul id="recordList"><li>æš«ç„¡è¨˜éŒ„</li></ul>

    <hr>

    <h3>ğŸ“ˆ æ”¯å‡ºçµ±è¨ˆ</h3>
    <div id="statsBox" class="stat-box">
      <p>ä»Šæ—¥ç¸½æ”¯å‡ºï¼š<span id="todayTotal">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 7 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg7Days">0</span> å…ƒ</p>
      <p>æœ€è¿‘ 30 å¤©å¹³å‡æ¯æ—¥æ”¯å‡ºï¼š<span id="avg30Days">0</span> å…ƒ</p>
      <p>ç•¶æœˆç´¯è¨ˆæ”¯å‡ºï¼š<span id="monthTotal">0</span> å…ƒ</p>
      <p id="warningMsg" style="color:#c0392b; font-weight:bold;"></p>
      <p>é æ¸¬ä¸‹é€±æ”¯å‡ºï¼šç´„ <span id="forecastWeek">0</span> å…ƒ</p>
    </div>
  </section>

  <section class="container">
    <h2>ğŸ“ˆ è‚¡ç¥¨æŸ¥è©¢</h2>
    <div class="flex-row">
      <div class="flex-grow"><input type="text" id="symbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰" /></div>
      <button onclick="loadStock()">æŸ¥è©¢</button>
    </div>

    <div class="flex-row" style="margin-top:10px; gap:40px;">
      <div class="flex-grow">
        <h4>â­ è‡ªé¸è‚¡æ¸…å–®</h4>
        <ul id="favoriteList"></ul>
        <div style="margin-top:10px;">
          <input type="text" id="newFavorite" placeholder="æ–°å¢è‚¡ç¥¨ä»£ç¢¼" />
          <button onclick="addFavorite()">æ–°å¢è‡ªé¸è‚¡</button>
        </div>
      </div>
      <div class="flex-grow" style="min-width:300px;">
        <h4>ğŸ“Š è‚¡åƒ¹èµ°å‹¢åœ–</h4>
        <canvas id="chart"></canvas>
      </div>
    </div>
  </section>
</div>

  <script>
    let userRef = null; 

    function initForUser(user){
      userRef = db.ref(`users/${user}/records`);
      document.getElementById('roleSelect').value = user; 
      loadRecentRecords();
      updateStats();
    }

    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const USERS = {
  mom: "mom",
  dad: "dad",
  debby: "debby",
  xiaoguai: "930352"
};

function login(){
  const user = document.getElementById('loginUser').value;
  const pass = document.getElementById('loginPassword').value.trim();

  if(pass === USERS[user]){
    localStorage.setItem('currentUser', user);
    alert(`æ­¡è¿å›ä¾†ï¼Œ${user}!`);
    document.getElementById('loginSection').style.display = 'none';
    document.getElementById('mainContent').style.display = 'block'; 
    initForUser(user);
  } else {
    alert("å¯†ç¢¼éŒ¯èª¤ï¼");
  }
}
    function logout() {
      localStorage.removeItem('currentUser');
      document.getElementById('mainContent').style.display = 'none';
      document.getElementById('loginSection').style.display = 'block';
      recordList.innerHTML = '<li>æš«ç„¡è¨˜éŒ„</li>';
      periodResult.textContent = 'è«‹é¸æ“‡æ—¥æœŸä¸¦é»æ“ŠæŸ¥è©¢';
      todayTotalEl.textContent = '0';
      avg7Days.textContent = '0';
      avg30Days.textContent = '0';
      monthTotalEl.textContent = '0';
      forecastWeek.textContent = '0';
      warningMsg.textContent = '';
      alert('æ‚¨å·²ç™»å‡ºï¼');
    }


    function setTheme(mode){
      document.body.classList.remove('theme-day','theme-night','theme-forest');
      document.body.classList.add(`theme-${mode}`);
      localStorage.setItem('themeMode', mode);
    }
    setTheme(localStorage.getItem('themeMode') || 'day');

    const favRef = db.ref('favorites/stockList');

    function addRecord(){
      const role = roleSelect.value;
      const category = categorySelect.value;
      const amount = parseFloat(amountInput.value);
      const desc = descriptionInput.value.trim();
      if(isNaN(amount)||amount<=0){ alert('è«‹è¼¸å…¥æœ‰æ•ˆé‡‘é¡'); return; }
      const now = new Date();
      const localDate = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);
      const record={role,category,amount,description:desc,timestamp:now.getTime(),date:localDate};
      userRef.push(record,err=>{
        if(err){alert('å„²å­˜å¤±æ•—');console.error(err);}
        else{alert('è¨˜å¸³æˆåŠŸ');amountInput.value='';descriptionInput.value='';loadRecentRecords();updateStats();}
      });
    }

    function loadRecentRecords(){
      userRef.orderByChild('timestamp').limitToLast(20).once('value',snap=>{
        const records=snap.val(),list=recordList;
        list.innerHTML='';
        if(!records){list.innerHTML='<li>æš«ç„¡è¨˜éŒ„</li>';return;}
        Object.values(records).sort((a,b)=>b.timestamp-a.timestamp).forEach(r=>{
          const li=document.createElement('li');
          li.textContent=`${r.date} - ${r.role} - ${r.category} - ${r.amount} å…ƒ - ${r.description}`;
          list.appendChild(li);
        });
      });
    }

    async function updateStats(){
      const snap=await userRef.once('value');
      const arr=Object.values(snap.val()||[]);
      if (arr.length === 0) return;
      
      const today = new Date(Date.now() - new Date().getTimezoneOffset() * 60000)
        .toISOString()
        .slice(0, 10);

      const now=Date.now(),day=86400000;
      const todayTotal=arr.filter(r=>r.date===today).reduce((s,r)=>s+r.amount,0);
      const arr7=arr.filter(r=>now-r.timestamp<7*day);
      const arr30 = arr.filter(r => now - r.timestamp < 30*day);
      
      const avg7 = +(arr7.reduce((s,r)=>s+r.amount,0)/7).toFixed(2);
      const avg30 = +(arr30.reduce((s,r)=>s+r.amount,0)/30).toFixed(2);
      const month=today.slice(0,7);
      const monthTotal=arr.filter(r=>r.date.startsWith(month)).reduce((s,r)=>s+r.amount,0);
      warningMsg.textContent=todayTotal>avg7*2?"âš ï¸ ä»Šæ—¥èŠ±å¤ªå¤šå•¦ï¼":"";
      todayTotalEl.textContent=todayTotal.toFixed(2);
      avg7Days.textContent = avg7.toFixed(2);
      avg30Days.textContent = avg30.toFixed(2);
      monthTotalEl.textContent = monthTotal.toFixed(2);
      forecastWeek.textContent = (avg7 * 7).toFixed(2);
    }

    async function queryPeriodExpenses(){
      const start=startDate.value,end=endDate.value;
      if(!start||!end){alert('è«‹è¼¸å…¥å®Œæ•´æ—¥æœŸ');return;}
      if(start>end){alert('é–‹å§‹æ—¥æœŸä¸èƒ½æ™šæ–¼çµæŸæ—¥æœŸ');return;}
      const snap=await userRef.once('value');
      const arr=Object.values(snap.val()||[]);
      const total=arr.filter(r=>r.date>=start&&r.date<=end).reduce((s,r)=>s+r.amount,0);
      periodResult.textContent=`æœŸé–“å…§ç¸½æ”¯å‡ºï¼š${total.toFixed(2)} å…ƒ (${start} ~ ${end})`;
    }

    function loadFavorites(){
      favRef.once('value',snap=>{
        const favs=snap.val()||{},list=favoriteList;
        list.innerHTML='';
        const codes=Object.keys(favs);
        if(codes.length===0){favRef.update({'2330':true,'0050':true});return loadFavorites();}
        codes.forEach(code=>{
          const li=document.createElement('li');
          li.textContent=code;
          li.addEventListener('click',()=>{symbolInput.value=code;loadStock();});
          list.appendChild(li);
        });
      });
    }

    function addFavorite(){
      const code=newFavorite.value.trim();
      if(!code.match(/^\d+$/)){alert('è«‹è¼¸å…¥æœ‰æ•ˆä»£ç¢¼');return;}
      favRef.update({[code]:true});newFavorite.value='';loadFavorites();
    }

    const chartCtx=document.getElementById('chart').getContext('2d');
    let stockChart=null;
    async function loadStock(){
      const symbol=symbolInput.value.trim();
      if(!symbol.match(/^\d+$/)){alert('è«‹è¼¸å…¥æœ‰æ•ˆä»£ç¢¼');return;}
      try{
        const res = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&stockNo=${symbol}`);
        const data = await res.json();
        console.log("TWSE å›å‚³ï¼š", data);
        
        if (data.stat !== "OK" || !data.data) {
          alert('æŸ¥è©¢å¤±æ•—ï¼ˆä»£ç¢¼éŒ¯èª¤æˆ–æš«ç„¡è³‡æ–™ï¼‰');
          return;
        }
        const labels = data.data.map(row => {
          const parts = row[0].split('/');
          const year = parseInt(parts[0]) + 1911; // æ°‘åœ‹è½‰è¥¿å…ƒ
          return `${year}-${parts[1]}-${parts[2]}`;
        });
        const prices = data.data.map(row => parseFloat(row[6].replace(/,/g, ''))); // æ”¶ç›¤åƒ¹
        if (stockChart) stockChart.destroy();
        stockChart = new Chart(chartCtx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: `${symbol} æ”¶ç›¤åƒ¹`,
              data: prices,
              borderColor: 'rgba(240,165,0,0.9)',
              backgroundColor: 'rgba(240,165,0,0.2)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { labels: { color: getComputedStyle(document.body).color } }
            },
            scales: {
              x: { ticks: { color: getComputedStyle(document.body).color } },
              y: { ticks: { color: getComputedStyle(document.body).color } }
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert('è‚¡ç¥¨æŸ¥è©¢å¤±æ•—ï¼ˆè«‹æª¢æŸ¥ç¶²è·¯æˆ– API ç‹€æ…‹ï¼‰');
      }
    }

    window.onload=()=>{
      const currentUser = localStorage.getItem('currentUser');
      if (!currentUser) {
        document.getElementById('mainContent').style.display = 'none';
        document.getElementById('loginSection').style.display = 'block';
      } else {
        document.getElementById('loginSection').style.display = 'none';
        document.getElementById('mainContent').style.display = 'block';
        initForUser(currentUser);
      }

      window.roleSelect = document.getElementById('roleSelect');
      window.categorySelect = document.getElementById('categorySelect');
      window.amountInput = document.getElementById('amountInput');
      window.descriptionInput = document.getElementById('descriptionInput');
      window.recordList = document.getElementById('recordList');
      window.periodResult = document.getElementById('periodResult');

      window.todayTotalEl = document.getElementById('todayTotal');
      window.avg7Days = document.getElementById('avg7Days');
      window.avg30Days = document.getElementById('avg30Days');
      window.monthTotalEl = document.getElementById('monthTotal');
      window.warningMsg = document.getElementById('warningMsg');
      window.forecastWeek = document.getElementById('forecastWeek');

      loadFavorites();

      console.log("âœ… Firebase initialized and elements bound");
    }; 

  </script>
</body>
</html>
