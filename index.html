<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>豬豬內網</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    input, button {
      padding: 8px;
      font-size: 16px;
    }
    #info {
      margin-top: 20px;
    }
    .field {
      margin-bottom: 12px;
    }
    #chart {
      width: 100%;
      height: 300px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .announcement {
      background-color: #f0f0f0;
      padding: 10px;
      border-left: 5px solid orange;
      margin-bottom: 20px;
    }
    .dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .dark-mode .announcement {
      background-color: #2a2a2a;
      border-left-color: #ffa500;
    }
    .toggle-button {
      float: right;
      margin-top: -50px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>🐷 豬豬內網</h1>
    <button class="toggle-button" onclick="toggleDarkMode()">切換夜間模式</button>
    <h3>🐷 豬豬公告區</h3>
    <div class="announcement">📢 1010烤肉不見不散！</div>
  </div>

  <div class="announcement">📈 健康資訊區</div>
  <div class="field"><strong>心率：</strong><span id="heartRate">讀取中...</span></div>
  <div class="field"><strong>步數：</strong><span id="steps">讀取中...</span></div>
  <div class="field"><strong>體溫：</strong><span id="temperature">讀取中...</span></div>

  <hr />

  <input type="text" id="symbolInput" placeholder="輸入股票代碼（如 2330）" />
  <button onclick="loadStock()">查詢</button>

  <div id="info">
    <div class="field"><strong>名稱：</strong><span id="name"></span></div>
    <div class="field"><strong>代碼：</strong><span id="code"></span></div>
    <div class="field"><strong>最新成交價：</strong><span id="price"></span></div>
    <div class="field"><strong>昨日收盤：</strong><span id="yesterdayClose"></span></div>
    <div class="field"><strong>漲跌：</strong><span id="change"></span></div>
    <div class="field"><strong>成交量：</strong><span id="volume"></span></div>
    <div class="field"><strong>昨日成交量：</strong><span id="yesterdayVolume"></span></div>
  </div>

  <canvas id="chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let isDark = false;

    function toggleDarkMode() {
      isDark = !isDark;
      document.body.classList.toggle('dark-mode', isDark);
    }

    async function loadStock() {
      const symbol = document.getElementById("symbolInput").value.trim();
      if (!symbol) {
        alert("請輸入股票代碼");
        return;
      }

      try {
        const searchResp = await fetch(`https://www.twse.com.tw/zh/api/codeQuery?query=${symbol}`);
        const searchData = await searchResp.json();

        if (!searchData.suggestions || searchData.suggestions.length === 0) {
          alert("查無此股票代碼");
          return;
        }

        const firstSuggestion = searchData.suggestions[0];
        const [code, name] = firstSuggestion.split("\t");

        document.getElementById("name").textContent = name;
        document.getElementById("code").textContent = code;

        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;

        const priceResp = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${code}`);
        const priceData = await priceResp.json();

        if (priceData.stat !== "OK" || !priceData.data || priceData.data.length === 0) {
          alert("無法取得價格資料");
          return;
        }

        const last20 = priceData.data.slice(-20);
        const labels = last20.map(d => d[0]);
        const closePrices = last20.map(d => parseFloat(d[6].replace(/,/g, '')));
        const volumes = last20.map(d => parseInt(d[1].replace(/,/g, ''), 10));

        const latestPrice = closePrices[closePrices.length - 1];
        const yesterdayClose = closePrices[closePrices.length - 2];
        const latestVolume = volumes[volumes.length - 1];
        const yesterdayVolume = volumes[yesterdayVolume.length - 2];

        document.getElementById("price").textContent = latestPrice;
        document.getElementById("yesterdayClose").textContent = yesterdayClose;
        document.getElementById("volume").textContent = latestVolume.toLocaleString();
        document.getElementById("yesterdayVolume").textContent = yesterdayVolume.toLocaleString();

        const changeAmount = (latestPrice - yesterdayClose).toFixed(2);
        const changePercent = ((changeAmount / yesterdayClose) * 100).toFixed(2);
        const changeText = `${changeAmount} (${changePercent}%)`;

        const changeSpan = document.getElementById("change");
        changeSpan.textContent = changeText;
        changeSpan.style.color = changeAmount > 0 ? "red" : (changeAmount < 0 ? "green" : "gray");

        if (window.myChart) window.myChart.destroy();

        const ctx = document.getElementById('chart').getContext('2d');
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: '收盤價',
              data: closePrices,
              borderColor: 'blue',
              backgroundColor: 'rgba(0,0,255,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: false }
            }
          }
        });

      } catch (error) {
        alert("錯誤發生，請稍後再試");
        console.error(error);
      }
    }
  </script>

  <!-- Firebase 讀取健康資料 -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const heartRateRef = ref(db, "health/heartRate");
    const stepsRef = ref(db, "health/steps");
    const tempRef = ref(db, "health/temperature");

    onValue(heartRateRef, (snapshot) => {
      document.getElementById("heartRate").textContent = snapshot.val() + " bpm";
    });

    onValue(stepsRef, (snapshot) => {
      document.getElementById("steps").textContent = snapshot.val() + " 步";
    });

    onValue(tempRef, (snapshot) => {
      document.getElementById("temperature").textContent = snapshot.val() + " ℃";
    });
  </script>
</body>
</html>
