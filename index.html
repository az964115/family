<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>🐷 豬豬內網 - 多功能總覽</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 720px;
      margin: 20px auto;
      padding: 20px;
      background: #fff9f0;
      color: #333;
      line-height: 1.6;
    }
    h1, h2 {
      text-align: center;
      color: #d35400;
    }
    .section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 0 10px #f0b27a88;
      padding: 15px 25px;
      margin-bottom: 25px;
    }
    .section h2 {
      margin-bottom: 15px;
      border-bottom: 2px solid #f39c12;
      padding-bottom: 5px;
    }
    #weatherIcon {
      vertical-align: middle;
      width: 40px;
      height: 40px;
    }
    .quote {
      font-style: italic;
      font-size: 1.2rem;
      color: #6e2c00;
      margin: 15px 0;
      text-align: center;
    }
    .news-list {
      list-style: none;
      padding: 0;
    }
    .news-list li {
      margin-bottom: 10px;
    }
    .news-list a {
      color: #d35400;
      text-decoration: none;
    }
    .news-list a:hover {
      text-decoration: underline;
    }
    #stockChange {
      font-weight: bold;
    }
    .stock-up {
      color: red;
    }
    .stock-down {
      color: green;
    }
    .tools {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .tool-box {
      border: 1px solid #f0b27a;
      border-radius: 8px;
      padding: 15px;
      width: 320px;
      background: #fff3e0;
      box-shadow: 2px 2px 8px #f7d6a7;
    }
    input[type="number"], input[type="text"] {
      width: 100%;
      padding: 6px;
      font-size: 1rem;
      margin-bottom: 10px;
      border: 1px solid #d35400;
      border-radius: 4px;
    }
    button {
      background-color: #d35400;
      border: none;
      color: white;
      padding: 10px 15px;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      width: 100%;
    }
    button:hover {
      background-color: #e67e22;
    }
    #countdownDisplay {
      font-size: 2rem;
      color: #af601a;
      text-align: center;
      margin-top: 10px;
      font-weight: bold;
    }
    @media (max-width: 700px) {
      .tools {
        flex-direction: column;
        align-items: center;
      }
      .tool-box {
        width: 90%;
      }
    }
  </style>
</head>
<body>

  <h1>🐷 豬豬內網 - 多功能總覽</h1>

  <!-- 天氣資訊區 -->
  <section class="section" id="weatherSection">
    <h2>📍 天氣資訊</h2>
    <div>
      <strong>城市：</strong><span id="city">讀取中...</span><br />
      <strong>天氣：</strong><img id="weatherIcon" src="" alt="weather icon" /> <span id="weatherDesc">讀取中...</span><br />
      <strong>溫度：</strong><span id="temp">--</span> ℃<br />
      <strong>濕度：</strong><span id="humidity">--</span> %
    </div>
  </section>

  <!-- 每日一句 -->
  <section class="section" id="quoteSection">
    <h2>💡 每日一句勵志語錄</h2>
    <div class="quote" id="dailyQuote">讀取中...</div>
  </section>

  <!-- 新聞簡報 -->
  <section class="section" id="newsSection">
    <h2>📰 今日熱門新聞</h2>
    <ul class="news-list" id="newsList">
      <li>讀取中...</li>
    </ul>
  </section>

  <!-- 股市總覽 -->
  <section class="section" id="stockSection">
    <h2>📈 台灣股市總覽</h2>
    <input type="text" id="symbolInput" placeholder="輸入股票代碼（如 2330）" />
    <button onclick="loadStock()">查詢</button>
    <div id="stockInfo" style="margin-top: 15px;">
      <div><strong>名稱：</strong><span id="name"></span></div>
      <div><strong>代碼：</strong><span id="code"></span></div>
      <div><strong>最新成交價：</strong><span id="price"></span></div>
      <div><strong>昨日收盤：</strong><span id="yesterdayClose"></span></div>
      <div><strong>漲跌：</strong><span id="change" id="stockChange"></span></div>
      <div><strong>成交量：</strong><span id="volume"></span></div>
      <div><strong>昨日成交量：</strong><span id="yesterdayVolume"></span></div>
    </div>
    <canvas id="chart" style="margin-top:15px;"></canvas>
  </section>

  <!-- 小工具區 -->
  <section class="section" id="toolsSection">
    <h2>🛠 小工具區</h2>
    <div class="tools">
      <!-- 計算機 -->
      <div class="tool-box" id="calculatorBox">
        <h3>計算機</h3>
        <input type="text" id="calcInput" placeholder="輸入算式，例如：3+4*2" />
        <button onclick="calculate()">計算</button>
        <div id="calcResult" style="margin-top: 10px; font-weight:bold;"></div>
      </div>

      <!-- 倒數計時器 -->
      <div class="tool-box" id="countdownBox">
        <h3>倒數計時器</h3>
        <input type="number" id="countdownInput" placeholder="輸入秒數" />
        <button onclick="startCountdown()">開始倒數</button>
        <div id="countdownDisplay"></div>
      </div>
    </div>
  </section>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // 天氣API設定（請先自行申請OpenWeatherMap免費API KEY）
    const weatherApiKey = '67fc7a1bcf794a2c46fc07c639b0048d';
    const cityName = 'Taoyuan'; // 你也可以用動態定位取得城市

    async function loadWeather() {
      try {
        const res = await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${weatherApiKey}&units=metric&lang=zh_tw`);
        const data = await res.json();
        if (data.cod !== 200) {
          document.getElementById('city').textContent = '無法取得天氣';
          document.getElementById('weatherDesc').textContent = '';
          return;
        }
        document.getElementById('city').textContent = data.name;
        document.getElementById('temp').textContent = data.main.temp.toFixed(1);
        document.getElementById('humidity').textContent = data.main.humidity;
        document.getElementById('weatherDesc').textContent = data.weather[0].description;
        document.getElementById('weatherIcon').src = `https://openweathermap.org/img/wn/${data.weather[0].icon}.png`;
      } catch (e) {
        document.getElementById('city').textContent = '錯誤發生';
        document.getElementById('weatherDesc').textContent = '';
        console.error(e);
      }
    }

    // 每日一句勵志語錄陣列
    const quotes = [
      "成功不是終點，失敗也不是終結，最重要的是繼續前進。",
      "學習如逆水行舟，不進則退。",
      "你的時間有限，不要浪費於重複別人的生活。",
      "不經歷風雨，怎能見彩虹？",
      "心有多大，舞台就有多大。",
      "困難是成功的墊腳石，勇敢迎接它。",
      "每天進步一點點，勝過停滯不前。",
      "熱愛生活，生活才會回報你。",
      "不要害怕改變，改變是成長的開始。",
      "夢想不是空想，而是行動的開始。"
    ];
    function showQuote() {
      const idx = Math.floor(Math.random() * quotes.length);
      document.getElementById('dailyQuote').textContent = quotes[idx];
    }

    // 新聞簡報 (NewsAPI)
    // 請先申請 https://newsapi.org 免費API KEY
    const newsApiKey = 'a884a483999c4ef6b89fdf13b4c0a072';

    async function loadNews() {
      try {
        const res = await fetch(`https://newsapi.org/v2/top-headlines?country=tw&apiKey=${newsApiKey}`);
        const data = await res.json();
        const list = document.getElementById('newsList');
        list.innerHTML = '';
        if (!data.articles || data.articles.length === 0) {
          list.innerHTML = '<li>找不到新聞</li>';
          return;
        }
        data.articles.slice(0, 5).forEach(article => {
          const li = document.createElement('li');
          li.innerHTML = `<a href="${article.url}" target="_blank" rel="noopener">${article.title}</a>`;
          list.appendChild(li);
        });
      } catch(e) {
        document.getElementById('newsList').innerHTML = '<li>新聞載入失敗</li>';
        console.error(e);
      }
    }

    // 股市查詢 - 你原本的TWSE API
    async function loadStock() {
      const symbol = document.getElementById("symbolInput").value.trim();
      if (!symbol) {
        alert("請輸入股票代碼");
        return;
      }
      try {
        const searchResp = await fetch(`https://www.twse.com.tw/zh/api/codeQuery?query=${symbol}`);
        const searchData = await searchResp.json();

        if (!searchData.suggestions || searchData.suggestions.length === 0) {
          alert("查無此股票代碼");
          return;
        }

        const firstSuggestion = searchData.suggestions[0];
        const [code, name] = firstSuggestion.split("\t");

        document.getElementById("name").textContent = name;
        document.getElementById("code").textContent = code;

        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;

        const priceResp = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${code}`);
        const priceData = await priceResp.json();

        if (priceData.stat !== "OK" || !priceData.data || priceData.data.length === 0) {
          alert("無法取得價格資料");
          return;
        }

        const last20 = priceData.data.slice(-20);
        const labels = last20.map(d => d[0]);
        const closePrices = last20.map(d => parseFloat(d[6].replace(/,/g, '')));
        const volumes = last20.map(d => parseInt(d[1].replace(/,/g, ''), 10));

        const latestPrice = closePrices[closePrices.length - 1];
        const yesterdayClose = closePrices[closePrices.length - 2];
        const latestVolume = volumes[volumes.length - 1];
        const yesterdayVolume = volumes[volumes.length - 2];

        document.getElementById("price").textContent = latestPrice;
        document.getElementById("yesterdayClose").textContent = yesterdayClose;
        document.getElementById("volume").textContent = latestVolume.toLocaleString();
        document.getElementById("yesterdayVolume").textContent = yesterdayVolume.toLocaleString();

        const changeAmount = (latestPrice - yesterdayClose).toFixed(2);
        const changePercent = ((changeAmount / yesterdayClose) * 100).toFixed(2);
        const changeSpan = document.getElementById("change");
        changeSpan.textContent = `${changeAmount} (${changePercent}%)`;
        if (changeAmount > 0) {
          changeSpan.className = 'stock-up';
        } else if (changeAmount < 0) {
          changeSpan.className = 'stock-down';
        } else {
          changeSpan.className = '';
        }

        if (window.myChart) window.myChart.destroy();

        const ctx = document.getElementById('chart').getContext('2d');
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: '收盤價',
              data: closePrices,
              borderColor: 'blue',
              backgroundColor: 'rgba(0,0,255,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: false }
            }
          }
        });

      } catch (error) {
        alert("錯誤發生，請稍後再試");
        console.error(error);
      }
    }

    // 計算機功能
    function calculate() {
      const input = document.getElementById('calcInput').value;
      try {
        // eslint-disable-next-line no-eval
        const result = eval(input);
        document.getElementById('calcResult').textContent = '結果：' + result;
      } catch {
        document.getElementById('calcResult').textContent = '錯誤：請輸入有效的數學表達式';
      }
    }

    // 倒數計時器功能
    let countdownTimer = null;
    function startCountdown() {
      if (countdownTimer) clearInterval(countdownTimer);
      let seconds = parseInt(document.getElementById('countdownInput').value);
      if (isNaN(seconds) || seconds <= 0) {
        alert('請輸入正確的秒數');
        return;
      }
      const display = document.getElementById('countdownDisplay');
      display.textContent = seconds;

      countdownTimer = setInterval(() => {
        seconds--;
        display.textContent = seconds;
        if (seconds <= 0) {
          clearInterval(countdownTimer);
          display.textContent = '時間到！⏰';
          alert('倒數計時結束！');
        }
      }, 1000);
    }

    // 頁面載入時執行
    window.onload = () => {
      loadWeather();
      showQuote();
      loadNews();
    };
  </script>

</body>
</html>
