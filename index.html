<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>TWSE 股票查詢示範</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #info { margin-top: 20px; }
    .field { margin-bottom: 10px; }
  </style>
</head>
<body>
  <h1>台股查詢（TWSE API）</h1>
  <input type="text" id="symbolInput" placeholder="輸入股票代碼（如 2330）" />
  <button onclick="loadStock()">查詢</button>

  <div id="info">
    <div class="field"><strong>名稱：</strong><span id="name"></span></div>
    <div class="field"><strong>代碼：</strong><span id="code"></span></div>
    <div class="field"><strong>成交價：</strong><span id="price"></span></div>
  </div>

  <script>
    async function loadStock() {
      const symbol = document.getElementById("symbolInput").value.trim();
      if (!symbol) {
        alert("請輸入股票代碼");
        return;
      }

      try {
        // 先用 codeQuery 查名稱與代碼
        const searchResp = await fetch(`https://www.twse.com.tw/zh/api/codeQuery?query=${symbol}`);
        const searchData = await searchResp.json();

        if (!searchData.suggestions || searchData.suggestions.length === 0) {
          alert("查無此股票代碼");
          return;
        }

        // 建立資料：範例 "2330\t台積電"
        const firstSuggestion = searchData.suggestions[0];
        const [code, name] = firstSuggestion.split("\t");

        document.getElementById("name").textContent = name;
        document.getElementById("code").textContent = code;

        // 再去抓當天股票成交價（以最近交易日當日價格）
        const today = new Date();
        const dateStr = today.getFullYear().toString() +
                        String(today.getMonth() + 1).padStart(2, "0") +
                        String(today.getDate()).padStart(2, "0");

        const priceResp = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${code}`);
        const priceData = await priceResp.json();

        if (priceData.stat !== "OK" || !priceData.data || priceData.data.length === 0) {
          document.getElementById("price").textContent = "無法取得價格";
          return;
        }

        // 取得最新成交價：data 最後一筆資料的「成交價」欄位(價格欄位通常是第6個 index)
        const lastTrade = priceData.data[priceData.data.length -1];
        const closingPrice = lastTrade[6]; 

        document.getElementById("price").textContent = closingPrice;

      } catch (error) {
        alert("發生錯誤，請稍後再試");
        console.error(error);
      }
    }
  </script>
</body>
</html>
