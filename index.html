<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>è±¬è±¬å…§ç¶²</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 700px;
      margin: auto;
      background-color: white;
      color: black;
      transition: background-color 0.3s, color 0.3s;
    }
    input, button {
      padding: 8px;
      font-size: 16px;
    }
    #info {
      margin-top: 20px;
    }
    .field {
      margin-bottom: 12px;
    }
    #chart {
      width: 100%;
      height: 300px;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .announcement {
      background-color: #f0f0f0;
      padding: 10px;
      border-left: 5px solid orange;
      margin-bottom: 20px;
    }
    .dark-mode {
      background-color: #121212;
      color: #f0f0f0;
    }
    .dark-mode .announcement {
      background-color: #2a2a2a;
      border-left-color: #ffa500;
    }
    .toggle-button {
      float: right;
      margin-top: -50px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>ğŸ· è±¬è±¬å…§ç¶²</h1>
    <button class="toggle-button" onclick="toggleDarkMode()">åˆ‡æ›å¤œé–“æ¨¡å¼</button>
    <h3>ğŸ· è±¬è±¬å…¬å‘Šå€</h3>
    <div class="announcement">ğŸ“¢ 1010çƒ¤è‚‰ä¸è¦‹ä¸æ•£ï¼</div>
  </div>

  <div class="announcement">ğŸ“ˆ å¥åº·è³‡è¨Šå€</div>
  <div class="field"><strong>å¿ƒç‡ï¼š</strong><span id="heartRate">è®€å–ä¸­...</span></div>
  <div class="field"><strong>æ­¥æ•¸ï¼š</strong><span id="steps">è®€å–ä¸­...</span></div>
  <div class="field"><strong>é«”æº«ï¼š</strong><span id="temperature">è®€å–ä¸­...</span></div>

  <hr />

  <input type="text" id="symbolInput" placeholder="è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼ï¼ˆå¦‚ 2330ï¼‰" />
  <button onclick="loadStock()">æŸ¥è©¢</button>

  <div id="info">
    <div class="field"><strong>åç¨±ï¼š</strong><span id="name"></span></div>
    <div class="field"><strong>ä»£ç¢¼ï¼š</strong><span id="code"></span></div>
    <div class="field"><strong>æœ€æ–°æˆäº¤åƒ¹ï¼š</strong><span id="price"></span></div>
    <div class="field"><strong>æ˜¨æ—¥æ”¶ç›¤ï¼š</strong><span id="yesterdayClose"></span></div>
    <div class="field"><strong>æ¼²è·Œï¼š</strong><span id="change"></span></div>
    <div class="field"><strong>æˆäº¤é‡ï¼š</strong><span id="volume"></span></div>
    <div class="field"><strong>æ˜¨æ—¥æˆäº¤é‡ï¼š</strong><span id="yesterdayVolume"></span></div>
  </div>

  <canvas id="chart"></canvas>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let isDark = false;

    function toggleDarkMode() {
      isDark = !isDark;
      document.body.classList.toggle('dark-mode', isDark);
    }

    async function loadStock() {
      const symbol = document.getElementById("symbolInput").value.trim();
      if (!symbol) {
        alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£ç¢¼");
        return;
      }

      try {
        const searchResp = await fetch(`https://www.twse.com.tw/zh/api/codeQuery?query=${symbol}`);
        const searchData = await searchResp.json();

        if (!searchData.suggestions || searchData.suggestions.length === 0) {
          alert("æŸ¥ç„¡æ­¤è‚¡ç¥¨ä»£ç¢¼");
          return;
        }

        const firstSuggestion = searchData.suggestions[0];
        const [code, name] = firstSuggestion.split("\t");

        document.getElementById("name").textContent = name;
        document.getElementById("code").textContent = code;

        const today = new Date();
        const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, "0")}${String(today.getDate()).padStart(2, "0")}`;

        const priceResp = await fetch(`https://www.twse.com.tw/exchangeReport/STOCK_DAY?response=json&date=${dateStr}&stockNo=${code}`);
        const priceData = await priceResp.json();

        if (priceData.stat !== "OK" || !priceData.data || priceData.data.length === 0) {
          alert("ç„¡æ³•å–å¾—åƒ¹æ ¼è³‡æ–™");
          return;
        }

        const last20 = priceData.data.slice(-20);
        const labels = last20.map(d => d[0]);
        const closePrices = last20.map(d => parseFloat(d[6].replace(/,/g, '')));
        const volumes = last20.map(d => parseInt(d[1].replace(/,/g, ''), 10));

        const latestPrice = closePrices[closePrices.length - 1];
        const yesterdayClose = closePrices[closePrices.length - 2];
        const latestVolume = volumes[volumes.length - 1];
        const yesterdayVolume = volumes[yesterdayVolume.length - 2];

        document.getElementById("price").textContent = latestPrice;
        document.getElementById("yesterdayClose").textContent = yesterdayClose;
        document.getElementById("volume").textContent = latestVolume.toLocaleString();
        document.getElementById("yesterdayVolume").textContent = yesterdayVolume.toLocaleString();

        const changeAmount = (latestPrice - yesterdayClose).toFixed(2);
        const changePercent = ((changeAmount / yesterdayClose) * 100).toFixed(2);
        const changeText = `${changeAmount} (${changePercent}%)`;

        const changeSpan = document.getElementById("change");
        changeSpan.textContent = changeText;
        changeSpan.style.color = changeAmount > 0 ? "red" : (changeAmount < 0 ? "green" : "gray");

        if (window.myChart) window.myChart.destroy();

        const ctx = document.getElementById('chart').getContext('2d');
        window.myChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [{
              label: 'æ”¶ç›¤åƒ¹',
              data: closePrices,
              borderColor: 'blue',
              backgroundColor: 'rgba(0,0,255,0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            scales: {
              y: { beginAtZero: false }
            }
          }
        });

      } catch (error) {
        alert("éŒ¯èª¤ç™¼ç”Ÿï¼Œè«‹ç¨å¾Œå†è©¦");
        console.error(error);
      }
    }
  </script>

  <!-- Firebase è®€å–å¥åº·è³‡æ–™ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCGSq-8joudLdCEB954krl3diNqMQXmsxg",
      authDomain: "piggynet-93c33.firebaseapp.com",
      databaseURL: "https://piggynet-93c33-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "piggynet-93c33",
      storageBucket: "piggynet-93c33.appspot.com",
      messagingSenderId: "65171780729",
      appId: "1:65171780729:web:ce5f7272f25a75f43490a8"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const heartRateRef = ref(db, "health/heartRate");
    const stepsRef = ref(db, "health/steps");
    const tempRef = ref(db, "health/temperature");

    onValue(heartRateRef, (snapshot) => {
      document.getElementById("heartRate").textContent = snapshot.val() + " bpm";
    });

    onValue(stepsRef, (snapshot) => {
      document.getElementById("steps").textContent = snapshot.val() + " æ­¥";
    });

    onValue(tempRef, (snapshot) => {
      document.getElementById("temperature").textContent = snapshot.val() + " â„ƒ";
    });
  </script>
</body>
</html>
